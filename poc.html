<!DOCTYPE html>
<html lang="">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Aventuras Fantásticas - A Cidadela do Caos</title>
  <link rel="stylesheet" href="estilo.css">
  <script src="jquery-3.3.1.min.js"></script>
  <script src="p5.js"></script>
  <script src="p5.dom.js"></script>
  <script src="dado.js"></script>
  <script src="sketch.js"></script>
</head>

<body>
    <div id="wrapper">
        <div id="container">
            <section class="open-book">
                <header>
                    <h1>Book Layout</h1>
                    <h6>Erin E. Sullivan</h6>
                </header>
                <article>
                    <div class="pagina-texto">
                        <p class="texto">
                        </p>
                        <ul class="opcoes">
                            
                        </ul>
                    </div>
                    <div class="pagina-img">
                        <img src="" id="painel-img">
                    </div>
                </article>
                <footer>
                    <ol id="page-numbers">
                        <li>1</li>
                        <li>2</li>
                    </ol>
                </footer>
            </section>

            <div class="combate-container">
                <h1 class="token-turno">Sua vez</h1>
                <div class="ficha-heroi">
                    <h3 class="heroi-nome">Alucard</h3>
                    <ul class="heroi-status">
                        <li class="heroi-energia">Energia<span class="box">12</span></li>
                        <li class="heroi-habilidade">Habilidade<span class="box">12</span></li>
                        <li class="heroi-sorte">Sorte<span class="box">12</span></li>
                    </ul>
                </div>
                <div id="area-sketch"></div>
                <div class="ficha-inimigo">
                    <h3 class="inimigo-nome">Cerberus</h3>
                    <ul class="inimigo-status">
                        <li class="inimigo-energia">Energia<span class="box">12</span></li>
                        <li class="inimigo-habilidade">Habilidade<span class="box">12</span></li>
                        <li class="inimigo-sorte">Sorte<span class="box">12</span></li>
                    </ul>
                </div>
            </div>

            <div class="selecionar-personagem-container">
                <h1>Escolha a classe do seu personagem</h1>

                <div class="selecionar-personagem-inner">
                    <ul class="selecionar-personagem-classes-personagem">
                        <li class="classe-personagem" data-classe="0">Guerreiro</li>
                        <li class="classe-personagem" data-classe="1">Mago</li>
                        <li class="classe-personagem" data-classe="2">Clérigo</li>
                    </ul>

                    <div class="lado-direito">
                        <div class="selecionar-personagem-imagem-classe">
                            <div class="efeito-top"></div>
                                <img class="imagem-classe" src="img/char_guerreiro.jpg">
                            <div class="efeito-bottom"></div>
                        </div>
                        <div class="selecionar-personagem-atributos-container">
                            <ul class="selecionar-personagem-atributos">
                                <li class="selecionar-personagem-atributo energia">Energia <span class="attr_valor">X</span></li>
                                <li class="selecionar-personagem-atributo habilidade">Habilidade <span class="attr_valor">X</span></li>
                                <li class="selecionar-personagem-atributo sorte">Sorte <span class="attr_valor">X</span></li>
                            </ul>

                            <ul class="selecionar-personagem-magias">
                                <li class="magia">Ouro dos tolos</li>
                            </ul>

                        </div>
                    </div>
                </div>

                <div class="botao-criar-personagem">
                    <h2>Criar personagem</h2>
                </div>

            </div>

            <div class="criar-personagem-container">
                <ul class="criar-personagem-status">
                    <li class="criar-personagem-atributo energia">Energia
                        <span class="attr_valor energia">X</span>
                        <button class="criar-personagem-botao-rolar-dado" data-origem="energia">Rolar dado</button>
                    </li>
                    <li class="criar-personagem-atributo habilidade">Habilidade
                        <span class="attr_valor habilidade">X</span>
                        <button class="criar-personagem-botao-rolar-dado" data-origem="habilidade">Rolar dado</button>
                    </li>
                    <li class="criar-personagem-atributo sorte">Sorte
                        <span class="attr_valor sorte">X</span>
                        <button class="criar-personagem-botao-rolar-dado" data-origem="sorte">Rolar dado</button>
                    </li>
                </ul>

                <fieldset class="criar-personagem-magias">
                    <legend> Escolha suas magias </legend>
                    <div class="lista-magias">
                        
                    </div>
                </fieldset>

                <button>Criar Personagem</button>
            </div>
        </div>
    </div>
    <script>
        var hero_status = {nome:"Alucard",energia:0,habilidade:0,sorte:0};
        var enemy_status = {nome:"Cerberus",energia:12,habilidade:8,sorte:6};
        var personagens_status = [ guerreiro_status = {nome:"Guerreiro", energia:24, habilidade:10, sorte:7}, mago_status = {nome:"Mago", energia:15, habilidade:7, sorte:11}, clerigo_status = {nome:"Clérigo", energia:19, habilidade:9, sorte:9}];
        var hero_turn = true;
        var poder_ataque_hero = 0;
        var poder_ataque_enemy = 0;
        var max_magias = 3;

        $.getJSON('https://api.myjson.com/bins/ut85k', function(data){
            livrocompleto = data;
            pagina_start = 1;
            var teste;

            //SELECIONAR PERSONAGEM
            $(".selecionar-personagem-classes-personagem .classe-personagem").mouseover(function(){
                var tmp_class = $(this).attr("data-classe");
                atualizaStatusSelPersonagem(tmp_class);
            });

            $(".selecionar-personagem-classes-personagem .classe-personagem").on('click',function(){
                hero_status = personagens_status[$(this).attr("data-classe")];
                $(".selecionar-personagem-container").css('display','none');
            });

            //TELA CRIAÇÃO PERSONAGEM
            $(".botao-criar-personagem").on('click',function(){
                $(".selecionar-personagem-container").css("display","none");
                $(".criar-personagem-container").css("display","block");
            });

            //LOGICA CRIAÇÃO PERSONAGEM
            $("button.criar-personagem-botao-rolar-dado").on('click',function(){
                var atributo = $(this).attr("data-origem");

                $(".combate-container").css("display","flex");
                
                $("#area-sketch button").on('click',function(){ 
                   
                    mesa_dados.limpaDados();
                    mesa_dados.limpaTela();
                    mesa_dados.criaDados(2);
                    var num_rolado = mesa_dados.rolaDado();

                    if(atributo=='energia' || atributo=='habilidade'){
                        num_rolado+=12;
                    }
                    else if(atributo=='sorte'){
                        num_rolado+=6;
                    }
                    
                    $(".criar-personagem-atributo span.attr_valor."+atributo).text(num_rolado);
                    $(".combate-container").css("display","none");
                    atributo = null;
                    console.log("DENTRO DO COMBATE "+atributo);

                });
                $(this).css("display","none");
                
            });

            $("input[type=checkbox]").on('click',function(){
                console.log("bip");
                // if($(".item-magia:checked").length > 2){
                //     this.checked = false;
                // }

            });

                        
            atualizaPagina(retornaPagina(pagina_start));
            populaMagias();
        }),'jsonp';   
             
        function retornaPagina(page){
            return(livrocompleto.pagina[page-1]);
        }

        function populaMagias(){
            var pai = $("fieldset.criar-personagem-magias .lista-magias");
            pai.empty();
                    
            for(i=0;i<livrocompleto.magias.length;i++){
                var filho = "<div><input class='item-magia' type = 'checkbox' id = 'magia"+i+
                            "' name = 'magia"+i+"' valor = '"+livrocompleto.magias[i]+"'>"+
                            "<label for = 'magia"+i+"'>"+livrocompleto.magias[i]+"</label>"+
                        "</div>";
                pai.append(filho);
            }
        }

        function combate(irpara){
            mesa_dados.limpaDados();
            mesa_dados.limpaTela();
            
            if(hero_turn){
                if(hero_status.energia>0 && enemy_status.energia>0){
                    mesa_dados.criaDados(2);
                    poder_ataque_hero = mesa_dados.rolaDado();
                    hero_turn = false;
                    combate();
                }
                else{
                    console.log("ACABOU A LUTA");
                    $(".combate-container").css("display","none");
                    atualizaPagina(irpara);
                    hero_turn = true;
                    enemy_status.energia=12;
                    return true;
                }    
            }
            else{
                mesa_dados.criaDados(2);
                poder_ataque_enemy = mesa_dados.rolaDado();
                if(poder_ataque_hero>poder_ataque_enemy){
                    console.log("HERÓI");
                    enemy_status.energia-=2;
                    atualizaFichas();
                }
                else{
                    console.log("MONSTRO");
                    hero_status.energia-=2;
                    $("canvas.tela-efeitos").css("z-index",2);
                    tela_efeitos.hit();
                    $("canvas.tela-efeitos").css("z-index",0);
                    atualizaFichas();
                }
                console.log("Vida HERÓI:"+hero_status.energia+"\nVida MONSTRO:"+enemy_status.energia);
                hero_turn = true;
            }
        }

        function atualizaStatusSelPersonagem(classe_personagem){
            $(".selecionar-personagem-imagem-classe .imagem-classe").attr("src","img/char_"+personagens_status[classe_personagem].nome+".jpg");
            $(".selecionar-personagem-atributo.energia .attr_valor").text(personagens_status[classe_personagem].energia);
            $(".selecionar-personagem-atributo.habilidade .attr_valor").text(personagens_status[classe_personagem].habilidade);
            $(".selecionar-personagem-atributo.sorte .attr_valor").text(personagens_status[classe_personagem].sorte);
        }

        function atualizaFichas(){
            $(".heroi-nome").text(hero_status.nome);
            $(".heroi-status .heroi-energia .box").text(hero_status.energia);
            $(".heroi-status .heroi-habilidade .box").text(hero_status.habilidade);
            $(".heroi-status .heroi-sorte .box").text(hero_status.sorte);
            $(".inimigo-nome").text(enemy_status.nome);
            $(".inimigo-status .inimigo-energia .box").text(enemy_status.energia);
            $(".inimigo-status .inimigo-habilidade .box").text(enemy_status.habilidade);
            $(".inimigo-status .inimigo-sorte .box").text(enemy_status.sorte);
        }
        
        function atualizaPagina(page){
            $(".texto").text(page.texto);
            
            if(page.id)
            
            if(page.questoes){
                if(page.questoes.length>0){
                    var pai = $(".open-book .pagina-texto .opcoes");
                    pai.empty();
                    
                    for(i=0;i<page.questoes.length;i++){
                        var filho = document.createElement('l1');
                        filho.className += "questao";
                        $(filho).attr("data-destino",page.questoes[i].destino);
                        filho.textContent = page.questoes[i].mensagem;
                        pai.append(filho);
                    }
                }
            }
            
            if(page.imagem!=null){
                $("#painel-img").attr("src","img/"+page.imagem);
            }
            else{
                $("#painel-img").attr("src","img/1.jpg");
            }
            
            if(page.combate){
                console.log("Prepare for battle!");
                $(".combate-container").css("display","flex");
                atualizaFichas();
                $("#area-sketch button").on('click',function(){                        
                   mesa_dados.limpaDados();
                   mesa_dados.limpaTela();
                   mesa_dados.criaDados(2);
                   var tt = mesa_dados.rolaDado();
                   console.log(tt);
                });
            }
            else{
                $(".combate-container").css("display","none");
            }
        }
        
        //MONITORA OPÇÃO ESCOLHIDA             
        $(document).on("click", ".questao", function(){
            var vapara = $(this).attr("data-destino");
            console.log(vapara);
            atualizaPagina(retornaPagina(vapara));
            
        });
        
        //LEGADO - RETIRAR
        function criaFicha(status){
            var indice = 1;
            $(".combate-container").css("display","flex");
            $(".combate-container .ficha-inimigo").css("display","none");
            $(".combate-container h1.token-turno").text("Crie seu personagem.");
            
            $("#area-sketch button").on('click',function(){                        
                mesa_dados.limpaDados();
                mesa_dados.limpaTela();
                mesa_dados.criaDados(2);
                switch(indice) {
                    case 1:
                        status.energia+=mesa_dados.rolaDado();
                        indice++;
                        break;
                    case 2:
                        status.habilidade+=mesa_dados.rolaDado();
                        indice++;
                        break;
                    case 3:
                        status.sorte+=mesa_dados.rolaDado();
                        indice++;
                        break;
                    case 4:
                        $("#area-sketch button").off('click');
                        $(".combate-container").css("display","none");
                        return true;
                }
                console.log(hero_status);
            });
        }
        
    </script>
</body>
</html>
